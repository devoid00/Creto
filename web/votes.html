<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>U.S. Congressional Votes</title>
  <link rel="stylesheet" href="/css/creto.css" />
</head>
<body class="page-votes">

  <!-- shared nav -->
  <div data-include="/nav.html"></div>

  <div class="wrap">
    <span class="badge">Votes Explorer • alpha</span>
    <h1>U.S. Congressional Votes</h1>
    <div class="muted" style="margin:6px 0 12px">
      <a href="/directory.html">← Back to directory</a>
    </div>

    <div class="panel">
      <div class="controls" style="margin-bottom:8px">
        <label>Congress
          <select id="cong"><option value="119">119th</option></select>
        </label>
        <label>Chamber
          <select id="chamber"><option value="house">House</option><option value="senate">Senate</option></select>
        </label>
        <label>Session
          <select id="sess"><option value="1">1st</option><option value="2">2nd</option></select>
        </label>
        <input id="q" type="search" placeholder="Search bill number, title, question…" />
        <span class="counts" id="counts"></span>
      </div>

      <div class="controls" style="margin-bottom:4px">
        <span class="pill" id="chip-close">Close votes</span>
        <span class="pill" id="chip-breaks">Party-line breaks</span>
        <span class="pill" id="chip-proc">Procedural</span>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:90px">Date</th>
            <th style="width:90px">Roll</th>
            <th style="width:120px">Bill</th>
            <th>Title / Question</th>
            <th style="width:150px">Result</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:10px">Data from official Senate & House vote records. Member-level detail loads on demand.</p>
  </div>

  <!-- Drawer -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <header>
      <div class="controls" style="justify-content:space-between">
        <div>
          <div class="muted" id="d-meta"></div>
          <div id="d-title" style="font-weight:700; margin-top:4px"></div>
        </div>
        <button id="d-close" class="btn">Close</button>
      </div>
    </header>
    <div class="content">
      <div id="d-summary" class="muted"></div>
      <div id="d-members" style="margin-top:10px"></div>
    </div>
  </aside>

  <script>
  const els = {
    cong:document.getElementById('cong'),
    chamber:document.getElementById('chamber'),
    sess:document.getElementById('sess'),
    q:document.getElementById('q'),
    counts:document.getElementById('counts'),
    rows:document.getElementById('rows'),
    chipClose:document.getElementById('chip-close'),
    chipBreaks:document.getElementById('chip-breaks'),
    chipProc:document.getElementById('chip-proc'),
    drawer:document.getElementById('drawer'),
    dClose:document.getElementById('d-close'),
    dMeta:document.getElementById('d-meta'),
    dTitle:document.getElementById('d-title'),
    dSummary:document.getElementById('d-summary'),
    dMembers:document.getElementById('d-members'),
  };
  let cache=new Map();
  let filters={ close:false, breaks:false, proc:false };

  // Use root-relative paths so they work from anywhere
  function dataPath(c,h,s){ return `/data/votes-${c}-${h}-${s}.json`; }
  function voteDetailPath(c,h,s,r){ return `/data/vote-${c}-${h}-${s}-${r}.json`; }

  async function loadList(){
    const c=els.cong.value,h=els.chamber.value,s=els.sess.value, key=`${c}-${h}-${s}`;
    if(!cache.has(key)){
      const res=await fetch(dataPath(c,h,s),{cache:'no-store'});
      cache.set(key, res.ok?await res.json():[]);
    }
    return cache.get(key);
  }

  function applyFilter(list){
    const q=els.q.value.trim().toLowerCase();
    let L=list;
    if(q) L=L.filter(r => (`${r.bill_number} ${r.title} ${r.question}`).toLowerCase().includes(q));
    // Procedural filter (approx)
    if(filters.proc){
      const W=['On the Motion to Proceed','Cloture','Agree to the Motion to Table','Order the Previous Question'];
      L=L.filter(r => W.some(w => (r.question||'').includes(w)));
    }
    els.counts.textContent = `${L.length} votes`;
    return L;
  }

  function rowHTML(r){
    const date=r.date||'', roll=r.rollcall, bill=r.bill_number||'—', result=r.result||'';
    const title=(r.title&&r.title.trim())?r.title:(r.question||'');
    return `<tr data-roll="${roll}">
      <td>${date}</td><td>${roll}</td><td>${bill}</td>
      <td style="max-width:620px">${title}</td><td>${result}</td>
    </tr>`;
  }

  async function render(){
    const L=applyFilter(await loadList());
    els.rows.innerHTML = L.map(rowHTML).join('');
    els.rows.querySelectorAll('tr').forEach(tr =>
      tr.addEventListener('click', ()=> openDrawer(parseInt(tr.dataset.roll,10)))
    );
  }

  async function openDrawer(roll){
    const c=els.cong.value,h=els.chamber.value,s=els.sess.value;
    const res=await fetch(voteDetailPath(c,h,s,roll),{cache:'no-store'});
    if(!res.ok) return;
    const v=await res.json();
    els.dMeta.textContent = `${v.congress}th • ${v.chamber} • session ${v.session} • Roll ${v.rollcall} • ${v.date}`;
    els.dTitle.textContent = v.title || v.question || '';
    els.dSummary.innerHTML = `
      <div>Result: <strong>${v.result}</strong></div>
      <div class="muted">Totals — Yea ${v.totals.yea}, Nay ${v.totals.nay}, Present ${v.totals.present}, Not Voting ${v.totals.nv}</div>
    `;
    const rows = (v.members||[]).map(m=>{
      const name=[m.last_name,m.first_name].filter(Boolean).join(', ');
      return `<div class="member">
        <div>${name} <span class="muted">(${m.party}-${m.state}${m.district?('-'+m.district):''})</span></div>
        <div class="score">${m.vote}</div>
      </div>`;
    }).join('');
    els.dMembers.innerHTML = rows || '<div class="muted">No member data.</div>';
    els.drawer.classList.add('open');
    els.drawer.setAttribute('aria-hidden','false');
  }

  function toggleChip(el,flag){ flag=!flag; el.classList.toggle('active',flag); return flag; }
  els.chipProc.addEventListener('click', ()=>{ filters.proc = toggleChip(els.chipProc, filters.proc); render(); });

  [els.cong,els.chamber,els.sess].forEach(el => el.addEventListener('change', render));
  els.q.addEventListener('input', render);
  els.dClose.addEventListener('click', ()=>{ els.drawer.classList.remove('open'); els.drawer.setAttribute('aria-hidden','true'); });

  render().catch(console.error);
  </script>

  <!-- partials loader for shared nav -->
  <script src="/js/partials.js"></script>
</body>
</html>
