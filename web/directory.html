<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Civic Index — Who’s in Office</title>
  <!-- External CSS -->
  <link rel="stylesheet" href="./css/creto.css" /> 
</head>
<body>
  <div class="wrap">
    <span class="badge">Live directory (auto-refreshed)</span>
    <h1>Who’s in Public Office — U.S. Congress</h1>

    <!-- Added tiny nav link to Votes Explorer -->
    <div class="muted" style="margin:8px 0 16px">
      <a href="./votes.html" style="color:var(--accent); text-decoration:none">→ Explore Congressional votes</a>
    </div>

    <div class="panel">
      <div class="controls">
        <input id="q" type="search" placeholder="Search name, state, party, district…" />
        <div class="counts" id="counts"></div>
      </div>

      <div class="section">
        <h2>Senate</h2>
        <div id="sen" class="grid"></div>
        <div class="empty" id="sen-empty" hidden>No matches in the Senate.</div>
      </div>

      <div class="section">
        <h2>House</h2>
        <div id="rep" class="grid"></div>
        <div class="empty" id="rep-empty" hidden>No matches in the House.</div>
      </div>
    </div>
  </div>

  <script>
    // ---------- image fallback helpers ----------
    const PLACEHOLDER =
      'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 450 550">
          <rect width="100%" height="100%" fill="#f0f0f0"/>
          <circle cx="225" cy="190" r="80" fill="#ddd"/>
          <rect x="90" y="300" width="270" height="180" rx="20" fill="#ddd"/>
        </svg>
      `);

    function buildImageHTML(member) {
      const id = member.bioguide || "";
      const primary = member.photo || (id ? `https://theunitedstates.io/images/congress/450x550/${id}.jpg` : "");
      const mirror  = id ? `https://unitedstates.github.io/images/congress/450x550/${id}.jpg` : "";

      const onErrPrimary = mirror
        ? `if(!this.dataset.mirror){this.dataset.mirror=1;this.src='${mirror}';}else{this.onerror=null;this.src='${PLACEHOLDER}';}`
        : `this.onerror=null;this.src='${PLACEHOLDER}';`;

      return `
        <img class="thumb" loading="lazy" referrerpolicy="no-referrer"
             src="${PLACEHOLDER}" data-src="${primary || PLACEHOLDER}"
             alt="${(member.official_full || '').replace(/"/g,'&quot;')}"
             onerror="${onErrPrimary}">
      `;
    }

    // ---------- card / render ----------
    const card = (m) => `
      <div class="card">
        ${buildImageHTML(m)}
        <div class="body">
          <div class="name">${m.official_full || ""}</div>
          <div class="muted">
            ${m.chamber === "sen" ? "Senator" : "Representative"} · ${m.state}${m.district ? ("-" + m.district) : ""}
          </div>
          <div class="muted">${m.party || ""}</div>
          <div class="links">
            ${m.url ? `<a href="${m.url}" target="_blank" rel="noopener">Official site ↗</a>` : ""}
          </div>
        </div>
      </div>
    `;

    function hydrateImages(rootEl){
      const imgs = rootEl.querySelectorAll('img[data-src]');
      imgs.forEach(img => {
        const real = img.getAttribute('data-src');
        if (real) img.src = real;
        img.removeAttribute('data-src');
        img.addEventListener('error', () => { img.src = PLACEHOLDER; }, { once:true });
      });
    }

    function render(list, el, emptyEl){
      el.innerHTML = list.map(card).join("");
      emptyEl.hidden = list.length !== 0;
      hydrateImages(el);
    }

    // ---------- main ----------
    async function main(){
      const res = await fetch("./members-current.json", { cache: "no-store" });
      const members = await res.json();

      const groups = {
        sen: members.filter(m => m.chamber === "sen"),
        rep: members.filter(m => m.chamber === "rep"),
      };

      const els = {
        sen: document.getElementById("sen"),
        rep: document.getElementById("rep"),
        senEmpty: document.getElementById("sen-empty"),
        repEmpty: document.getElementById("rep-empty"),
        q: document.getElementById("q"),
        counts: document.getElementById("counts"),
      };

      const filterer = (q) => (m) => {
        const hay = [
          m.official_full, m.first, m.last, m.party, m.state, m.chamber,
          (m.district || "").toString()
        ].join(" ").toLowerCase();
        return hay.includes(q);
      };

      function updateCounts(list){
        const senC = list.filter(m => m.chamber === "sen").length;
        const repC = list.filter(m => m.chamber === "rep").length;
        els.counts.textContent = `${senC} senators · ${repC} representatives · ${list.length} total`;
      }

      render(groups.sen, els.sen, els.senEmpty);
      render(groups.rep, els.rep, els.repEmpty);
      updateCounts(members);

      els.q.addEventListener("input", (e) => {
        const q = e.target.value.trim().toLowerCase();
        if (!q){
          render(groups.sen, els.sen, els.senEmpty);
          render(groups.rep, els.rep, els.repEmpty);
          updateCounts(members);
          return;
        }
        const filtered = members.filter(filterer(q));
        render(filtered.filter(m=>m.chamber==="sen"), els.sen, els.senEmpty);
        render(filtered.filter(m=>m.chamber==="rep"), els.rep, els.repEmpty);
        updateCounts(filtered);
      });
    }
        // Prefill search from ?state=XY
        const urlParams = new URLSearchParams(window.location.search);
        const stateParam = urlParams.get('state');
        if (stateParam) {
          const st = stateParam.trim().toUpperCase();
          // Some states are two-letter; your filter checks haystack text, so just set the input.
          document.getElementById('q').value = st;
          // Trigger the existing input handler to filter immediately
          document.getElementById('q').dispatchEvent(new Event('input', { bubbles:true }));
        }

    main().catch(err => {
      console.error(err);
      document.body.insertAdjacentHTML(
        "beforeend",
        `<div style="color:#ff4d4d;padding:16px">Failed to load roster. Please try again later.</div>`
      );
    });
  </script>
</body>
</html>
