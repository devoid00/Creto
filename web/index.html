<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Civic Index — Who’s in Office</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#0f1424; --card:#11182a; --ink:#e7ecf6; --muted:#a7b0c0;
      --line:#1b2236; --accent:#9cc0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); color:var(--ink);
    }

    /* Full-width, but keep comfy max for readability inside WordPress iframe too */
    .wrap{max-width:1200px; margin:0 auto; padding:24px 20px}

    .badge{display:inline-block; font-size:12px; letter-spacing:.2px;
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      color:#dbe6ff; background:#10162b; margin-bottom:12px;
    }

    h1{margin:0 0 16px; font-size:28px; line-height:1.2}
    h2{margin:24px 0 8px; font-size:18px; color:#d9e3f5}

    .controls{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      margin:12px 0 6px;
    }

    input[type="search"]{
      flex:1 1 360px; min-width:220px;
      padding:10px 12px; border-radius:10px; border:1px solid var(--line);
      background:#10162b; color:var(--ink); outline:none;
    }
    .counts{font-size:12px; color:var(--muted)}

    .panel{
      background:var(--panel); border:1px solid var(--line);
      border-radius:14px; padding:16px;
    }

    .grid{
      display:grid; gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      margin-top:12px;
    }

    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:14px; overflow:hidden; display:flex; flex-direction:column;
    }

    /* image */
    .thumb{
      width:100%; aspect-ratio: 9/11; object-fit:cover; display:block;
      background:#0f1424; border-bottom:1px solid var(--line);
    }

    .body{padding:12px}
    .name{font-weight:600; margin:2px 0 6px}
    .muted{color:var(--muted); font-size:13px; margin:2px 0}
    .links{margin-top:10px; font-size:13px}
    .links a{color:var(--accent); text-decoration:none}
    .links a:hover{text-decoration:underline}

    .section{margin-top:18px}
    .empty{color:var(--muted); padding:16px}

    /* make it breathe edge-to-edge on very small frames */
    @media (max-width:560px){
      .wrap{padding:16px 12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <span class="badge">Live directory (auto-refreshed)</span>
    <h1>Who’s in Public Office — U.S. Congress</h1>

    <div class="panel">
      <div class="controls">
        <input id="q" type="search" placeholder="Search name, state, party, district…" />
        <div class="counts" id="counts"></div>
      </div>

      <div class="section">
        <h2>Senate</h2>
        <div id="sen" class="grid"></div>
        <div class="empty" id="sen-empty" hidden>No matches in the Senate.</div>
      </div>

      <div class="section">
        <h2>House</h2>
        <div id="rep" class="grid"></div>
        <div class="empty" id="rep-empty" hidden>No matches in the House.</div>
      </div>
    </div>
  </div>

  <script>
    // ---------- image fallback helpers ----------
    const PLACEHOLDER =
      'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 450 550">
          <rect width="100%" height="100%" fill="#0f1424"/>
          <circle cx="225" cy="190" r="80" fill="#1b2236"/>
          <rect x="90" y="300" width="270" height="180" rx="20" fill="#1b2236"/>
        </svg>
      `);

    function buildImageHTML(member) {
      const id = member.bioguide || "";
      // Primary URL is already provided by fetch step; otherwise build it:
      const primary = member.photo || (id ? `https://theunitedstates.io/images/congress/450x550/${id}.jpg` : "");
      const mirror  = id ? `https://unitedstates.github.io/images/congress/450x550/${id}.jpg` : "";

      // We set src to placeholder, then flip to data-src after insert (lazy-ish).
      // onerror chain tries mirror, then placeholder.
      const onErrPrimary = mirror
        ? `if(!this.dataset.mirror){this.dataset.mirror=1;this.src='${mirror}';}else{this.onerror=null;this.src='${PLACEHOLDER}';}`
        : `this.onerror=null;this.src='${PLACEHOLDER}';`;

      return `
        <img class="thumb" loading="lazy" referrerpolicy="no-referrer"
             src="${PLACEHOLDER}" data-src="${primary || PLACEHOLDER}"
             alt="${(member.official_full || '').replace(/"/g,'&quot;')}"
             onerror="${onErrPrimary}">
      `;
    }

    // ---------- card / render ----------
    const card = (m) => `
      <div class="card">
        ${buildImageHTML(m)}
        <div class="body">
          <div class="name">${m.official_full || ""}</div>
          <div class="muted">
            ${m.chamber === "sen" ? "Senator" : "Representative"} · ${m.state}${m.district ? ("-" + m.district) : ""}
          </div>
          <div class="muted">${m.party || ""}</div>
          <div class="links">
            ${m.url ? `<a href="${m.url}" target="_blank" rel="noopener">Official site ↗</a>` : ""}
          </div>
        </div>
      </div>
    `;

    function hydrateImages(rootEl){
      const imgs = rootEl.querySelectorAll('img[data-src]');
      imgs.forEach(img => {
        const real = img.getAttribute('data-src');
        if (real) img.src = real;
        img.removeAttribute('data-src');
        img.addEventListener('error', () => { img.src = PLACEHOLDER; }, { once:true });
      });
    }

    function render(list, el, emptyEl){
      el.innerHTML = list.map(card).join("");
      emptyEl.hidden = list.length !== 0;
      hydrateImages(el);
    }

    // ---------- main ----------
    async function main(){
      const res = await fetch("./members-current.json", { cache: "no-store" });
      const members = await res.json();

      const groups = {
        sen: members.filter(m => m.chamber === "sen"),
        rep: members.filter(m => m.chamber === "rep"),
      };

      const els = {
        sen: document.getElementById("sen"),
        rep: document.getElementById("rep"),
        senEmpty: document.getElementById("sen-empty"),
        repEmpty: document.getElementById("rep-empty"),
        q: document.getElementById("q"),
        counts: document.getElementById("counts"),
      };

      const filterer = (q) => (m) => {
        const hay = [
          m.official_full, m.first, m.last, m.party, m.state, m.chamber,
          (m.district || "").toString()
        ].join(" ").toLowerCase();
        return hay.includes(q);
      };

      function updateCounts(list){
        const senC = list.filter(m => m.chamber === "sen").length;
        const repC = list.filter(m => m.chamber === "rep").length;
        els.counts.textContent = `${senC} senators · ${repC} representatives · ${list.length} total`;
      }

      // initial render
      render(groups.sen, els.sen, els.senEmpty);
      render(groups.rep, els.rep, els.repEmpty);
      updateCounts(members);

      // search
      els.q.addEventListener("input", (e) => {
        const q = e.target.value.trim().toLowerCase();
        if (!q){
          render(groups.sen, els.sen, els.senEmpty);
          render(groups.rep, els.rep, els.repEmpty);
          updateCounts(members);
          return;
        }
        const filtered = members.filter(filterer(q));
        render(filtered.filter(m=>m.chamber==="sen"), els.sen, els.senEmpty);
        render(filtered.filter(m=>m.chamber==="rep"), els.rep, els.repEmpty);
        updateCounts(filtered);
      });
    }

    main().catch(err => {
      console.error(err);
      document.body.insertAdjacentHTML(
        "beforeend",
        `<div style="color:#ffb4b4;padding:16px">Failed to load roster. Please try again later.</div>`
      );
    });
  </script>
</body>
</html>
