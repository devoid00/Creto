<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Civic Index — Who’s in Office</title>
  <style>
    :root{
      --bg:#0b0d12; --fg:#e6e9ef; --muted:#a7b0c0;
      --card:#111522; --b:#1b2236; --accent:#8ab4ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Full-bleed container so it can fill inside iframes/themes */
    .wrap{
      width:100%;
      max-width:1400px;
      margin:0 auto;
      padding:24px 20px;
    }

    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .badge{
      display:inline-block; padding:4px 10px; border:1px solid #2a3556;
      border-radius:999px; color:#dbe6ff; background:#10162b; font-size:12px
    }
    h1{margin:10px 0 14px; font-size:clamp(22px, 2.6vw, 34px)}

    label{font-size:14px; color:var(--muted)}
    select, input[type="text"]{
      padding:10px 12px; border-radius:10px; border:1px solid #2a3556;
      background:#10162b; color:var(--fg); outline:none
    }
    select{min-width:190px}
    .hint{color:var(--muted); font-size:13px; margin-top:8px}

    .section{margin-top:20px}
    .section h2{margin:18px 0 8px; font-size:clamp(18px,2vw,22px)}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:12px;
      margin-top:10px
    }
    .card{
      background:var(--card); border:1px solid var(--b);
      border-radius:14px; padding:12px; min-height:100%;
      display:flex; flex-direction:column; gap:10px;
    }
    .muted{color:var(--muted)}
    .name{font-weight:600; line-height:1.2}
    .links{margin-top:auto}
    .links a{color:var(--accent); text-decoration:none}
    .links a:hover{text-decoration:underline}

    img.thumb{
      width:100%; aspect-ratio:9/11; object-fit:cover;
      border-radius:10px; border:1px solid var(--b);
      background:#0f1424;
    }

    /* simple skeleton while loading */
    .skeleton{
      background:linear-gradient(90deg,#141a2b 25%,#182033 37%,#141a2b 63%);
      background-size:400% 100%;
      animation:shine 1.2s ease-in-out infinite;
    }
    @keyframes shine { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* make it breathe a bit on very small screens */
    @media (max-width:520px){
      .wrap{padding:16px 12px}
      select{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <span class="badge">Live directory (auto-refreshed)</span>
    <h1>Who’s in Public Office — U.S. Congress</h1>

    <div class="row" style="margin:6px 0 12px">
      <div>
        <label for="state">Choose your state</label><br/>
        <select id="state">
          <option value="">— Select —</option>
        </select>
      </div>
      <div>
        <label for="q">Filter by name / party / district</label><br/>
        <input id="q" type="text" placeholder="e.g., Murkowski, D, 3…" />
      </div>
    </div>
    <div class="hint">Pick a state to load its Senators and Representatives. Photos lazy-load; a placeholder appears if an image is unavailable.</div>

    <div class="section">
      <h2>Senate</h2>
      <div id="sen" class="grid"></div>
    </div>

    <div class="section">
      <h2>House</h2>
      <div id="rep" class="grid"></div>
    </div>
  </div>

  <script>
  // Tiny inline SVG placeholder (dark silhouette)
  const PLACEHOLDER =
    'data:image/svg+xml;utf8,' +
    encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 450 550">
        <rect width="100%" height="100%" fill="#0f1424"/>
        <circle cx="225" cy="190" r="80" fill="#1b2236"/>
        <rect x="90" y="300" width="270" height="180" rx="20" fill="#1b2236"/>
      </svg>`);

  const S = {
    sen: document.getElementById('sen'),
    rep: document.getElementById('rep'),
    stateSel: document.getElementById('state'),
    q: document.getElementById('q')
  };

  // Card renderer with lazy image + fallback
  const card = (m) => `
    <div class="card">
      <img class="thumb" loading="lazy"
           src="${PLACEHOLDER}"
           data-src="${m.photo || ''}"
           alt="${m.official_full || ''}"
           onerror="this.onerror=null;this.src='${PLACEHOLDER}'" />
      <div class="name">${m.official_full || ''}</div>
      <div class="muted">${m.chamber === 'sen' ? 'Senator' : 'Representative'} · ${m.state}${m.district ? ('-' + m.district) : ''}</div>
      <div class="muted">${m.party || ''}</div>
      <div class="links">
        ${m.url ? `<a href="${m.url}" target="_blank" rel="noopener">Official site ↗</a>` : ''}
      </div>
    </div>
  `;

  function render(list, el){
    el.innerHTML = list.map(card).join('');
    // swap data-src → src for lazy load after insertion
    const imgs = el.querySelectorAll('img[data-src]');
    imgs.forEach(img => {
      const real = img.getAttribute('data-src');
      if (real) img.src = real;
      img.removeAttribute('data-src');
    });
  }

  function skeleton(el, count=8){
    el.innerHTML = Array.from({length:count}).map(() => `
      <div class="card">
        <div class="thumb skeleton"></div>
        <div class="skeleton" style="height:14px; width:70%; border-radius:6px"></div>
        <div class="skeleton" style="height:12px; width:55%; border-radius:6px"></div>
        <div class="skeleton" style="height:12px; width:35%; border-radius:6px"></div>
      </div>`).join('');
  }

  // Load state index for dropdown
  async function loadStateIndex(){
    const res = await fetch('./api/states/index.json', {cache:'no-store'});
    if (!res.ok) throw new Error('Failed to load state index');
    const states = await res.json();
    states.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.state;
      opt.textContent = s.state;
      S.stateSel.appendChild(opt);
    });
  }

  // Fetch members for a state and render
  async function loadState(st){
    if (!st){
      S.sen.innerHTML = '';
      S.rep.innerHTML = '';
      return;
    }
    skeleton(S.sen); skeleton(S.rep);

    const res = await fetch(`./api/states/${encodeURIComponent(st)}.json`, {cache:'no-store'});
    if (!res.ok){
      S.sen.innerHTML = '<div class="muted">Could not load Senate.</div>';
      S.rep.innerHTML = '<div class="muted">Could not load House.</div>';
      return;
    }
    const data = await res.json();
    window.__STATE_MEMBERS__ = {
      sen: data.sen || [],
      rep: data.rep || []
    };
    // initial render (unfiltered)
    render(window.__STATE_MEMBERS__.sen, S.sen);
    render(window.__STATE_MEMBERS__.rep, S.rep);
  }

  // Text filter
  function applyFilter(){
    const q = (S.q.value || '').trim().toLowerCase();
    const filt = (m) => ([
      m.official_full, m.state, m.party, (m.district||'')
    ].join(' ').toLowerCase().includes(q));

    const src = window.__STATE_MEMBERS__ || {sen:[], rep:[]};
    render(src.sen.filter(filt), S.sen);
    render(src.rep.filter(filt), S.rep);
  }

  // Wire events
  S.stateSel.addEventListener('change', e => loadState(e.target.value));
  S.q.addEventListener('input', () => applyFilter());

  // Boot
  (async function init(){
    try{
      await loadStateIndex();
      // Optional: preselect based on URL hash e.g. #AK
      const hashState = (location.hash || '').replace('#','').toUpperCase();
      if (hashState){
        S.stateSel.value = hashState;
        await loadState(hashState);
      }
    }catch(err){
      console.error(err);
    }
  })();
  </script>
</body>
</html>
