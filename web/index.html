<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Civic Index — Who Represents Me?</title>

  <!-- Allow external images we depend on -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https://theunitedstates.io https://images.weserv.nl https://placehold.co data: blob:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline'">

  <style>
    :root{
      --bg:#0b0d12; --fg:#e6e9ef; --muted:#a7b0c0; --card:#111522; --b:#1b2236; --accent:#cfe0ff;
    }
    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--fg);
      line-height:1.45;
    }

    .wrap{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:32px 24px 64px;
    }

    h1{ margin:0 0 16px; font-size: clamp(24px, 3.2vw, 36px); }
    h2{ margin:28px 0 10px; font-size: clamp(18px, 2.2vw, 22px); }
    h3{ margin:10px 0 6px; font-size: clamp(16px, 2vw, 18px); }

    .badge{
      display:inline-block; margin-bottom:10px; padding:6px 12px;
      border:1px solid #2a3556; border-radius:999px; color:#dbe6ff; background:#10162b; font-size:12px;
    }

    .panel{
      background:#0f1426;
      border:1px solid var(--b);
      border-radius:14px;
      padding:16px;
      margin:10px 0 20px;
    }

    label{ display:block; margin:0 0 6px; color:var(--muted); }
    select, input{
      width:100%;
      max-width:480px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #2a3556;
      background:#10162b; color:var(--fg);
      outline:none;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap:16px; margin-top:16px;
    }

    .card{
      background:var(--card); border:1px solid var(--b); border-radius:14px; padding:12px;
      display:flex; flex-direction:column; gap:10px; min-height:100%;
    }

    .headshot{
      width:100%; height:300px; object-fit:cover; border-radius:10px; border:1px solid var(--b);
      background:#0f1220; display:block;
    }

    .muted{ color:var(--muted); }
    .meta { display:flex; gap:8px; flex-wrap:wrap; }
    .pill { border:1px solid #2a3556; border-radius:999px; padding:2px 8px; font-size:12px; color:#dbe6ff; background:#10162b; }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .promises{ margin-top:8px; }
    .promise-item{ padding:8px; border:1px dashed #2a3556; border-radius:10px; margin-top:6px; }
    .empty{ color:#8490a8; font-style:italic; }
  </style>
</head>
<body>
  <div class="wrap">
    <span class="badge">Live directory (auto-refreshed)</span>
    <h1>Who represents you?</h1>

    <div class="panel">
      <label for="state">Select your state</label>
      <select id="state"></select>
      <div style="height:10px"></div>
      <label for="q">Optional: filter by name, party, district…</label>
      <input id="q" placeholder="e.g., Smith, D, 7" />
    </div>

    <h2>Senate</h2>
    <div id="sen" class="grid"></div>

    <h2>House</h2>
    <div id="rep" class="grid"></div>
  </div>

  <script>
    const STATES = [
      ["AL","Alabama"],["AK","Alaska"],["AZ","Arizona"],["AR","Arkansas"],["CA","California"],["CO","Colorado"],
      ["CT","Connecticut"],["DE","Delaware"],["FL","Florida"],["GA","Georgia"],["HI","Hawaii"],["ID","Idaho"],
      ["IL","Illinois"],["IN","Indiana"],["IA","Iowa"],["KS","Kansas"],["KY","Kentucky"],["LA","Louisiana"],
      ["ME","Maine"],["MD","Maryland"],["MA","Massachusetts"],["MI","Michigan"],["MN","Minnesota"],["MS","Mississippi"],
      ["MO","Missouri"],["MT","Montana"],["NE","Nebraska"],["NV","Nevada"],["NH","New Hampshire"],["NJ","New Jersey"],
      ["NM","New Mexico"],["NY","New York"],["NC","North Carolina"],["ND","North Dakota"],["OH","Ohio"],["OK","Oklahoma"],
      ["OR","Oregon"],["PA","Pennsylvania"],["RI","Rhode Island"],["SC","South Carolina"],["SD","South Dakota"],
      ["TN","Tennessee"],["TX","Texas"],["UT","Utah"],["VT","Vermont"],["VA","Virginia"],["WA","Washington"],
      ["WV","West Virginia"],["WI","Wisconsin"],["WY","Wyoming"],["DC","District of Columbia"],["PR","Puerto Rico"]
    ];

    // Always go through an image proxy first (reliable), then placeholder if even that fails.
    function buildHeadshot(url){
      const img = document.createElement('img');
      img.className = 'headshot';
      img.loading = 'lazy';
      img.referrerPolicy = 'no-referrer';
      img.alt = '';

      const path = (url || '').replace(/^https?:\/\//, '');
      img.src = 'https://images.weserv.nl/?url=' + encodeURIComponent(path || 'theunitedstates.io/does-not-exist');

      img.addEventListener('error', function onErr(){
        img.removeEventListener('error', onErr);
        img.src = 'https://placehold.co/450x550?text=No+Photo';
      }, { once:true });

      return img;
    }

    function cardHTML(m, promisesFor) {
      const site = m.url ? `<a href="${m.url}" target="_blank" rel="noopener">Official site ↗</a>` : '';
      const promises = promisesFor[m.bioguide] || [];
      const promisesHtml = promises.length
        ? promises.map(p => `
            <div class="promise-item">
              <div><strong>${p.title || "Promise"}</strong></div>
              <div class="muted">${p.summary || ""}</div>
              ${p.source ? `<div><a href="${p.source}" target="_blank" rel="noopener">source ↗</a></div>` : ""}
            </div>
          `).join('')
        : `<div class="empty">No promises tracked yet.</div>`;

      return `
        <div class="card">
          <div class="image-wrap"></div>
          <h3>${m.official_full}</h3>
          <div class="meta">
            <span class="pill">${m.chamber === "sen" ? "Senator" : "Representative"}</span>
            <span class="pill">${m.state}${m.district ? ("-" + m.district) : ""}</span>
            ${m.party ? `<span class="pill">${m.party}</span>` : ""}
          </div>
          ${site}
          <div class="promises">
            <div class="muted">Promises</div>
            ${promisesHtml}
          </div>
        </div>
      `;
    }

    function attachImages(members, mount){
      const cards = mount.querySelectorAll('.card');
      members.forEach((m, i) => {
        const wrap = cards[i].querySelector('.image-wrap');
        wrap.appendChild(buildHeadshot(m.photo));
      });
    }

    function renderList(arr, mount, promises){
      mount.innerHTML = arr.map(m => cardHTML(m, promises)).join('');
      attachImages(arr, mount);
    }

    function filterFn(q){
      const needle = q.trim().toLowerCase();
      if (!needle) return () => true;
      return (m) => [m.official_full, m.state, m.party, (m.district || "")]
        .join(" ")
        .toLowerCase()
        .includes(needle);
    }

    async function loadJSON(url){
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error("Fetch failed " + r.status);
      return r.json();
    }

    async function main(){
      // Load members + optional promises file
      const [members, promises] = await Promise.all([
        loadJSON("./members-current.json"),
        // If promises.json is missing, fall back to empty.
        loadJSON("./promises.json").catch(()=> ({})),
      ]);

      // Populate state dropdown
      const sel = document.getElementById('state');
      sel.innerHTML = `<option value="">Select a state…</option>` +
        STATES.map(([code,name]) => `<option value="${code}">${name}</option>`).join('');

      const senRoot = document.getElementById('sen');
      const repRoot = document.getElementById('rep');
      const q = document.getElementById('q');

      function update(){
        const code = sel.value;
        const f = filterFn(q.value);
        if (!code){
          senRoot.innerHTML = '<div class="muted">Select a state to see senators.</div>';
          repRoot.innerHTML = '<div class="muted">Select a state to see representatives.</div>';
          return;
        }
        const sen = members.filter(m => m.chamber === "sen" && m.state === code).filter(f);
        const rep = members.filter(m => m.chamber === "rep" && m.state === code).filter(f);
        renderList(sen, senRoot, promises);
        renderList(rep, repRoot, promises);
      }

      sel.addEventListener('change', update);
      q.addEventListener('input', update);

      // Initial state (empty)
      update();
    }

    main();
  </script>
</body>
</html>
